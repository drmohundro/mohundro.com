
title: "Real world walkthrough with WinDbg"
author: David
date: 2008/05/22

<p>Most of the work I currently do (during the day) is with WinForms applications and most of the time, debugging their problems really isn't all that hard. Application hangs or crashes that only occur on one machine at a remote location are <em>not</em> easy though. We ran into one of those situations a few weeks back. I told our support group that if they saw the hang again to let me know and I would swing by so that we could get a memory dump of the application and start debugging it. Here's everything I did to figure out what went wrong.</p> <p>First thing, install <a href="http://www.microsoft.com/whdc/DevTools/Debugging/default.mspx">Debugging Tools for Windows</a>. This will get you things like adplus and windbg. Make sure you pick the right version for your platform (i.e. x86 or x64) because the debugger has to match the platform you're debugging on. I already had it installed on my machine, but I shared the directory so that I could access the tools on the remote machine that was having the hang.</p> <p>Next, I remoted into the machine with the problem and ran <a href="http://msdn.microsoft.com/en-us/library/cc265639.aspx">adplus</a> to get a memory dump. To do this, I first copied over the debugging directory to the remote machine from my share. Luckily, the Debugging Tools can be copied and therefore don't need an MSI or setup executable. To get the dump, I pulled up a command prompt, moved to the debugging directory, and ran '<span style="font-size: 12pt; font-family: consolas, monospace">adplus -hang -p 3423</span>' where 3423 was the process ID for the application that was hanging. If you're dealing with an application that is crashing, you would need to pass different arguments in. By the way, note that adplus is just a VBScript - this means that you can open it and see what they're doing if you're so inclined. You can get the PID from either task manager or process explorer.</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_2.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="50" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb.png" width="550" border="0"></a> </p> <p>Let this script run to completion and it should create the memory dump (in this case, a <a href="http://msdn.microsoft.com/en-us/library/ms680369(VS.85).aspx">minidump</a>) in a directory that looks something like this:</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_6.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="200" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_2.png" width="644" border="0"></a> </p> <p>I then zipped up this directory and copied it back over to my machine so that the user could get back to work :-) Get back to your desk because you'll be able to do everything else there.</p> <p>This is where it gets fun, because we get to use WinDbg. Before doing any real work with WinDbg, I would strongly recommend getting your colors customized because it is very hard to spot errors or warnings when all the text is black on white. Check out <a href="http://blogs.msdn.com/tess/archive/2008/04/18/pimp-up-your-debugger-creating-a-custom-workspace-for-windbg-debugging.aspx">Tess's post on setting up a custom workspace for WinDbg</a>. I set up WinDbg exactly as she did in the post and it works quite well.</p> <p>Next, you can open your minidump. Under the File menu, there is an "Open Crash Dump" command that you can use (Ctrl+D for you keyboard guys) so pull that up and open your minidump file. It should look something like this:</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_8.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="469" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_3.png" width="644" border="0"></a> </p> <p>You can think of WinDbg sort of like a command prompt, even though it has windows and buttons. It is just as user friendly as the command prompt is when you're sitting at the C: prompt. In other words, it isn't friendly at all. In this case, instead of a C: prompt, you have the prompt at the bottom of the screen.</p> <p>WinDbg starts out as an unmanaged/native debugger, which means you could debug your managed application, but it will be fairly difficult with just native commands. What you need to use is a tool called <a href="http://msdn.microsoft.com/en-us/library/bb190764(VS.80).aspx">SOS</a>. <a href="http://www.wintellect.com/cs/blogs/jrobbins/default.aspx">John Robbin's, master debugging guru guy</a>, has an excellent <a href="http://msdn.microsoft.com/en-us/library/bb190764(VS.80).aspx">MSDN Magazine article on SOS</a> that you should read for more information. My next step was to load up the SOS extension in WinDbg by typing '<span style="font-size: 12pt; font-family: consolas, monospace">.loadby sos mscorwks</span>' which tells WinDbg to load the SOS extension from the same directory as the mscorwks assembly was loaded from. (check out <a href="http://blogs.msdn.com/johan/archive/2007/11/13/getting-started-with-windbg-part-i.aspx#6503848">this comment for cases when the loadby might not work</a>, such as when mscorwks hasn't been loaded yet)</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_10.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="73" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_4.png" width="240" border="0"></a> </p> <p>When I typed it in, I unfortunately got an error, though (pasted below for Googlibility, if that's a word).</p><pre style="font-size: 12pt; font-family: consolas, monospace"><p>PDB symbol for mscorwks.dll not loaded<br>Failed to load data access DLL, 0x80004005<br>Verify that 1) you have a recent build of the debugger (6.2.14 or newer)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2) the file mscordacwks.dll that matches your version of mscorwks.dll is <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in the version directory<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3) or, if you are debugging a dump file, verify that the file <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mscordacwks_&lt;arch&gt;_&lt;arch&gt;_&lt;version&gt;.dll is on your symbol path.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4) you are debugging on the same architecture as the dump file.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For example, an IA64 dump file must be debugged on an IA64<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; machine. 
<p>You can also run the debugger command .cordll to control the debugger's<br>load of mscordacwks.dll.&nbsp; .cordll -ve -u -l will do a verbose reload.<br>If that succeeds, the SOS command should work on retry. 
<p>If you are debugging a minidump, you need to make sure that your executable<br>path is pointing to mscorwks.dll as well. </p></pre>
<p>This got me digging for a while to figure out why I couldn't load up SOS. <a href="http://www.google.com/search?hl=en&amp;q=loadby+sos+mscorwks+%22data+access+dll%22&amp;btnG=Search">Quite a few other people were curious</a>, too. The gist of it can be summed up in <a href="https://connect.microsoft.com/VisualStudio/feedback/Validation.aspx?FeedbackID=299021">this Microsoft Connect post</a>, which details that you have to have the exact same version of the .NET Framework as the machine where the minidump was taken. In short, I had installed .NET 3.5 on my machine which included patches to .NET 2.0 while the user who was having the problem was a few versions back.</p>
<p>To confirm this, you can use the loaded modules command (lm) to see all of the modules that were loaded at the time of the minidump. I specifically used '<span style="font-size: 12pt; font-family: consolas, monospace">lmv m mscorwks</span>'. The 'v' apparently means details or something and the 'm mscorwks' tells the command to match on modules named 'mscorwks'. Here is the result, with the file version info from my local mscorwks file as well (found in c:\windows\microsoft.net\framework\v2.0.50727).</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_16.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="267" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_7.png" width="644" border="0"></a> </p>
<p>Don't despair if you're in this situation, because I have a solution. Virtual machines! It takes a bit of work, but you can get a VM set up with the same framework version. I started out with blank Windows XP SP2 VM and installed the .NET Framework 2.0 RTM on it. Turns out, I was still off. The below screenshot is from the VM.</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_18.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="484" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_8.png" width="591" border="0"></a> </p>
<p>I was starting to get frustrated at this point, but <a href="http://blogs.msdn.com/dougste/default.aspx">Doug Stewart</a> saved the day with a couple of posts on .NET 2.0 versions, <a href="http://blogs.msdn.com/dougste/archive/2007/11/22/6467645.aspx">one on .NET 2.0 revisions</a> and <a href="http://blogs.msdn.com/dougste/archive/2007/09/06/version-history-of-the-clr-2-0.aspx">one on the version history of the CLR 2.0</a>. I was able to determine that the problem computer was running a <a href="http://support.microsoft.com/kb/928365">patch from KB928365</a>. I installed the patch on the VM and... SUCCESS! SOS loaded up!</p>
<p>With SOS loaded, you run a lot more interesting and powerful commands from WinDbg, like !threads, !CLRStack, !analyze and more. Here are the basic steps I took to attempt to narrow down what was going on.</p>
<p>I ran !threads, which displayed all of the threads that were running at the time the minidump was taken.</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_20.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="275" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_9.png" width="644" border="0"></a> </p>
<p>You can see that, though it looks like a lot was going on, there really was the main STA thread (the thread that contains the WndProc which pumps the Windows messages) and a lot of system threads like the Finalizer threads and Completion Port threads.</p>
<p>You can switch between threads, by using the ~[THREAD]s command, like ~11s, which switches to the thread with the ID of 11. Once switched to a thread, you can run !clrstack and get the call stack for that thread.</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_22.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="180" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_10.png" width="644" border="0"></a> </p>
<p>It looks like thread 11 was an animation timer. Back on the main thread (STA), it really just looks like normal WndProc activity - nothing too strange.</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_24.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="230" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_11.png" width="644" border="0"></a> </p>
<p>It was looking like I wasn't getting anywhere, so I decided to try something else. I ran the DumpStackObjects (!dso) command, which gives me all of the object instances on the stack.</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_26.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="120" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_12.png" width="644" border="0"></a> </p>
<p>Looks like the application in question was using an Infragistics library, but the thing I was really interested in was the bottom one, the WinFormsAppContext, which was an instance of an <a href="http://msdn.microsoft.com/en-us/library/system.windows.forms.applicationcontext.aspx">ApplicationContext</a>. From that instance, I could run the !do (dump object) command to see details about it.</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_28.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="163" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_13.png" width="644" border="0"></a> </p>
<p>From there, I wanted to find which mainForm it was using. I ran !do on the Value column of the mainForm instance.</p>
<p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_30.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="356" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/RealworldwalkthroughwithWinDbg_8BDB/image_thumb_14.png" width="644" border="0"></a> </p>
<p>Nice! Now I know the name of the instance that was loaded! At this point, I've got a much better idea about what is going on and can now start digging through some code to try to determine what it is doing.</p>
<p>The rest of the story is fairly boring because, after opening the offending code, I spotted the problem fairly quickly. The hang, if you even want to call it that, had nothing to do with threading. It just looked like the application was hanging because, in the Form's Closing event, the application in question was cancelling the close and hiding itself. I have no idea why, but I guess that's debugging for you.</p>
<p>To finish off, I'd like to share some excellent debugging resources, particularly with WinDbg.</p>
<ul>
<li><a href="http://blogs.msdn.com/tess/default.aspx">Anything from Tess's blog. Period.</a> 
<li><a href="http://www.wintellect.com/cs/blogs/jrobbins/default.aspx">John Robbin's blog</a> 
<li><a href="http://www.amazon.com/Debugging-Microsoft-NET-2-0-Applications/dp/0735622027">John Robbin's Debugging Microsoft .NET 2.0 Applications</a> - awesome book on debugging. 
<li><a href="http://blogs.msdn.com/johan/default.aspx">Johan Straarup</a> has a <a href="http://blogs.msdn.com/johan/archive/2007/11/13/getting-started-with-windbg-part-i.aspx">great post on getting started with WinDbg</a>. 
<li><a href="http://geekswithblogs.net/.netonmymind/archive/2006/03/14/72262.aspx">David Douglass's WinDbg / SOS Cheat Sheet</a></li></ul>
<p>Hope this helps!</p>
