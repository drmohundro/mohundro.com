
title: "NDepend - Static analysis on steroids"
author: David
date: 2008/03/25

<p>If you've been working with the .NET Framework for a while, you're hopefully already using some form of static analysis to help you catch problems with your code. One of the most well known is Microsoft's <a href="http://msdn2.microsoft.com/en-us/library/bb429476(VS.80).aspx">FxCop</a>, which is now integrated as the Code Analysis feature in Visual Studio 2005 <sup>[1]</sup> and up. If you're not already using this tool, then please start because it can help you find problem areas like potential NullReferenceExceptions as well as globalization and security issues.</p> <p>However, while FxCop is great at catching small problems and details, it isn't the best tool to see the big picture regarding your software. Enter <a href="http://www.ndepend.com/">NDepend</a> by <a href="http://codebetter.com/blogs/patricksmacchia/">Patrick Smacchia</a>. Chances are, you've already read <a href="http://www.hanselman.com/blog/">Scott Hanselman</a>'s <a href="http://www.hanselman.com/blog/ExitingTheZoneOfPainStaticAnalysisWithNDepend.aspx">great review of NDepend</a> a while back (or heard <a href="http://www.hanselman.com/blog/HanselminutesPodcast51StaticCodeAnalysisWithNDepend.aspx">his podcast on static analysis with NDepend</a>). If you haven't read it, go ahead and check it out. Scott uses NDepend to analyze <a href="http://dasblog.info/">dasBlog</a> (which I'm running), so you can get the general feel for working with NDepend and what the reports look like.</p> <p>I'd like to run through a few of the features of NDepend using <a href="http://www.ayende.com/projects/rhino-mocks/downloads.aspx">Rhino Mocks</a> as the target of my static analysis. Rhino Mocks is a neat example because it is only one assembly, but it is the result of an ILMerge of quite a few different libraries, so we get to see how NDepend handles this. Here is NDepend's class browser showing Rhino Mocks:</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_6.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="484" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_thumb_2.png" width="407" border="0"></a> </p> <p>As you can see, it handles Rhino Mocks accurately. In fact, it almost feels like the class browser in Reflector, so that is already a plus. In fact, as you can see, the context menu supports jumping to Reflector for the selected type.</p> <p>The "Who is directly using me?" option is also pretty cool and highlights the extensive use of CQL in NDepend:</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_8.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="130" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_thumb_3.png" width="644" border="0"></a> </p> <p>CQL, or <a href="http://www.ndepend.com/CQL.htm">Code Query Language</a>, is the centerpiece of NDepend and is how all of the analysis happens. You can think of it as SQL against IL. The massive benefit that NDepend has over FxCop <acronym title="in my humble opinion">IMHO</acronym> is that you can create your own analysis rules in CQL instead of having to write and compile a DLL to extend FxCop (for an example of this, check out <a href="http://www.binarycoder.net/fxcop/html/ar01s22.html">this FxCop rule that ensures that ArrayLists are List&lt;T&gt;s instead</a>). Even better, NDepend provides a complete editor <em>with intellisense</em> that allows you to test your queries out against your assemblies.</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_14.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="484" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_thumb_6.png" width="621" border="0"></a> </p> <p>Take a look at this screenshot. You can see the intellisense at the bottom right hand of the screen. At the top left is the CQL Query Results. The top right is all of the types in the assemblies, but the highlighted ones in blue are those that were returned by the query. This all happened <em>as I typed the query in</em>. Actually, I got red when I typed it in the first time, because my query had some mistakes in it, but NDepend was very helpful in showing me how to correct my query.</p> <p>The query editor also has different types of intellisense depending on the value.</p> <p><a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_16.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="90" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_thumb_7.png" width="479" border="0"></a> </p> <p>I'll admit that it might seem weird to have a slider when you're just typing a number in, but the cool part is when you change the value, the query results automatically change to reflect the new value. In this case, you can watch the results of the query to get a feel for which types have the most methods.</p> <p>From an agile coding perspective, NDepend ties in well with <a href="http://www.altnetpedia.com/ContinuousIntegration.ashx">Continuous Integration</a>. It ships with both a <a href="http://nant.sourceforge.net/">NANT</a> and an <a href="http://msdn2.microsoft.com/en-us/library/0k6kkbsd.aspx">MSBuild</a> task to run the NDepend console against an NDepend project file (which is just XML). The report that it provides is <em>insanely</em> detailed. I'd say this where the value of application-specific CQL queries would come in handy, because you can come up with some detailed queries that are run on every CI build to ensure that the code still matches whatever design criteria was decided upon when the queries were written.</p> <p>&nbsp;<a href="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_18.png"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="130" alt="image" src="http://www.mohundro.com/blog/content/binary/WindowsLiveWriter/NDependStaticanalysisonsteroids_E81A/image_thumb_8.png" width="644" border="0"></a> </p> <p>For future versions of the tool, I'd think it would be neat to have a lightweight version of the CQL tool that you could ad hoc queries against assemblies, like as a Reflector addin or something. That'd be cool. Or maybe a Powershell cmdlet/PSDrive provider so that you could do something like this:</p><pre><font color="#2b91af">Get-ChildItem</font> -Include *.dll -Recurse | <span style="color: #2b91af">Select</span>-Cql -Top <span style="color: maroon">10</span> -Methods -<span style="color: blue">Where</span> MethodCa -ge <span style="color: maroon">5</span></pre>
<p>Or maybe:</p><pre><font color="#2b91af">Get-ChildItem</font> -Include *.dll -Recurse | <span style="color: #2b91af">Select</span>-Cql -Top <span style="color: maroon">10</span> -Methods | <span style="color: blue">Where</span> { $_.MethodCa -ge <span style="color: maroon">5</span> }</pre>
<p>I'm not sure exactly how the syntax might look, but it would be really cool :-)</p>
<p>Hopefully, I've given you a good picture of the some of the features of NDepend. If your interest is at all piqued, there is a "Trial / Open Source / Academic Edition" that you can download for free. Its feature set isn't quite as broad as the Professional edition, but I've used it before and it still provides a lot of functionality. Check it out!</p>
<p>&nbsp;</p>
<p><strong>Full Disclosure</strong> - I used a review copy of NDepend for this post. My company is not (yet) using this tool, but I think that there is interest. I wasn't paid to do this. <strong>&lt;kidding&gt;</strong>If you, dear reader, would like to pay me, please contact me.<strong>&lt;/kidding&gt;</strong></p>
<p>&nbsp;</p>
<p><sup>[1]</sup> I don't believe that all of the SKUs of Visual Studio have the Code Analysis feature.</p>
<div class="wlWriterSmartContent" id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:5734396d-c404-44ee-841f-4af9f8e621a1" style="padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px">Technorati Tags: <a href="http://technorati.com/tags/NDepend" rel="tag">NDepend</a>,<a href="http://technorati.com/tags/Static%20Analysis" rel="tag">Static Analysis</a></div>
