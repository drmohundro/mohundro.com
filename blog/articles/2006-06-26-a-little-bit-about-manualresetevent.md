
title: "A little bit about ManualResetEvent"
author: David
date: 2006/06/26

I'm not sure how often people run into situations where the ManualResetEvent is needed, but I have a few times. System.Threading.ManualResetEvent provides an easy way to allow cross-thread communication and to let other threads know when something has completed. Most of the time that I've needed it, I have a property in a class that is loaded in another thread, but I want to prevent access to the property until it is loaded. From what I've seen, this is a great time to use the ManualResetEvent.<br><br>It is easiest to explain with some code snippets. Here's how you create the ManualResetEvent.<br><br><div style="font-family: Consolas,monospace; font-size: 9pt; background-color: white;"> <span style="color: Navy;">Private</span><span style="color: black;"> _dataLock </span><span style="color: Navy;">As</span><span style="color: black;"> </span><span style="color: Navy;">New</span><span style="color: black;"> ManualResetEvent(</span><span style="color: Navy;">False</span><span style="color: black;">)</span> </div> <br>The constructor takes a boolean that signifies whether the object is signaling or not. A signaling object implies that the action has been completed... we're done with the work. If signaling is false, the work hasn't finished yet.<br><br>To wait on the signal, use this code:<br><br><div style="font-family: Consolas,monospace; font-size: 9pt; background-color: white;"> _dataLock.WaitOne() </div> <br>You can also specify a period of time to wait instead of waiting indefinitely.<br><br>Once your background work is completed, you can call Set like so:<br><br><div style="font-family: Consolas,monospace; font-size: 9pt; background-color: white;"> _dataLock.Set() </div> <br>This begins signaling, so any calls to wait will stop blocking and will continue execution.<br><br>Here's a full code sample that shows how it would work and also gives a short example on the BackgroundWorker.<br><br><div style="font-family: Consolas,monospace; font-size: 9pt; background-color: white;"> <span style="color: Navy;">Imports</span><span style="color: black;"> System.ComponentModel<br></span><span style="color: Navy;">Imports</span><span style="color: black;"> System.Threading<br><br></span><span style="color: Navy;">Module</span><span style="color: black;"> Module1<br><br></span><span style="color: Navy;">Private</span><span style="color: black;"> _dataLock </span><span style="color: Navy;">As</span><span style="color: black;"> </span><span style="color: Navy;">New</span><span style="color: black;"> ManualResetEvent(</span><span style="color: Navy;">False</span><span style="color: black;">)<br><br></span><span style="color: Navy;">Sub</span><span style="color: black;"> Main()<br><br>        Thread.CurrentThread.Name = </span><span style="color: Maroon;">"[Main]"<br><br></span><span style="color: black;">        </span><span style="color: Navy;">Dim</span><span style="color: black;"> wkr </span><span style="color: Navy;">As</span><span style="color: black;"> </span><span style="color: Navy;">New</span><span style="color: black;"> BackgroundWorker<br></span><span style="color: Navy;">AddHandler</span><span style="color: black;"> wkr.DoWork, </span><span style="color: Navy;">AddressOf</span><span style="color: black;"> wkr_DoWork<br></span><span style="color: Navy;">AddHandler</span><span style="color: black;"> wkr.RunWorkerCompleted, </span><span style="color: Navy;">AddressOf</span><span style="color: black;"> wkr_RunWorkerCompleted<br><br>        wkr.RunWorkerAsync(</span><span style="color: Maroon;">"Get to work!"</span><span style="color: black;">)<br><br>        Write(</span><span style="color: Maroon;">"Waiting on the lock..."</span><span style="color: black;">)<br>        _dataLock.WaitOne()<br>        Write(</span><span style="color: Maroon;">"we're back!"</span><span style="color: black;">)<br><br><br>        Console.WriteLine(vbNewLine & </span><span style="color: Maroon;">"Press any key to continue..."</span><span style="color: black;">)<br>        Console.ReadLine()<br></span><span style="color: Navy;">End</span><span style="color: black;"> </span><span style="color: Navy;">Sub<br><br></span><span style="color: black;">    </span><span style="color: Navy;">Private</span><span style="color: black;"> </span><span style="color: Navy;">Sub</span><span style="color: black;"> wkr_DoWork(</span><span style="color: Navy;">ByVal</span><span style="color: black;"> sender </span><span style="color: Navy;">As</span><span style="color: black;"> </span><span style="color: Navy;">Object</span><span style="color: black;">, </span><span style="color: Navy;">ByVal</span><span style="color: black;"> e </span><span style="color: Navy;">As</span><span style="color: black;"> System.ComponentModel.DoWorkEventArgs)<br>        Thread.CurrentThread.Name = </span><span style="color: Maroon;">"[Work]"<br><br></span><span style="color: black;">        Write(</span><span style="color: Maroon;">"DoWork just received this value: "</span><span style="color: black;"> & </span><span style="color: Navy;">CStr</span><span style="color: black;">(e.Argument))<br>        Thread.Sleep(</span><span style="color: Red;">5000</span><span style="color: black;">)<br><br>        e.Result = </span><span style="color: Maroon;">"DoWork finished!"<br><br></span><span style="color: black;">        Write(</span><span style="color: Maroon;">"DoWork is done so start signaling completion."</span><span style="color: black;">)<br>        _dataLock.Set()<br></span><span style="color: Navy;">End</span><span style="color: black;"> </span><span style="color: Navy;">Sub<br><br></span><span style="color: black;">    </span><span style="color: Navy;">Private</span><span style="color: black;"> </span><span style="color: Navy;">Sub</span><span style="color: black;"> wkr_RunWorkerCompleted(</span><span style="color: Navy;">ByVal</span><span style="color: black;"> sender </span><span style="color: Navy;">As</span><span style="color: black;"> </span><span style="color: Navy;">Object</span><span style="color: black;">, </span><span style="color: Navy;">ByVal</span><span style="color: black;"> e </span><span style="color: Navy;">As</span><span style="color: black;"> System.ComponentModel.RunWorkerCompletedEventArgs)<br></span><span style="color: Navy;">Dim</span><span style="color: black;"> wkr </span><span style="color: Navy;">As</span><span style="color: black;"> BackgroundWorker = </span><span style="color: Navy;">DirectCast</span><span style="color: black;">(sender, BackgroundWorker)<br></span><span style="color: Navy;">RemoveHandler</span><span style="color: black;"> wkr.DoWork, </span><span style="color: Navy;">AddressOf</span><span style="color: black;"> wkr_DoWork<br></span><span style="color: Navy;">RemoveHandler</span><span style="color: black;"> wkr.RunWorkerCompleted, </span><span style="color: Navy;">AddressOf</span><span style="color: black;"> wkr_RunWorkerCompleted<br>        wkr.Dispose()<br></span><span style="color: Navy;">End</span><span style="color: black;"> </span><span style="color: Navy;">Sub<br><br></span><span style="color: black;">    </span><span style="color: Navy;">Private</span><span style="color: black;"> </span><span style="color: Navy;">Sub</span><span style="color: black;"> Write(</span><span style="color: Navy;">ByVal</span><span style="color: black;"> s </span><span style="color: Navy;">As</span><span style="color: black;"> </span><span style="color: Navy;">String</span><span style="color: black;">)<br>        Console.WriteLine(</span><span style="color: Navy;">String</span><span style="color: black;">.Format(</span><span style="color: Maroon;">"Thread: {0}, Message: {1}"</span><span style="color: black;">, Thread.CurrentThread.Name, s))<br></span><span style="color: Navy;">End</span><span style="color: black;"> </span><span style="color: Navy;">Sub<br><br>End</span><span style="color: black;"> </span><span style="color: Navy;">Module<br></span> </div> <br>The output from running looks like this:<br><pre>Thread: [Main], Message: Waiting on the lock...<br>Thread: [Work], Message: DoWork just received this value: Get to work!<br>Thread: [Work], Message: DoWork is done so start signaling completion.<br>Thread: [Main], Message: we're back!<br><br>Press any key to continue...</pre>One thing to remember: do NOT put the call to Set (i.e. _dataLock.Set()) in the thread where you are waiting (i.e. _dataLock.WaitOne())! You'll never get the signal because that thread is already blocking! Because of this, make sure your call to Set always happens in the DoWork event of the BackgroundWorker instead of the RunWorkerCompleted event.
