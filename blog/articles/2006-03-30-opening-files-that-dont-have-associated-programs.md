
title: "Opening files that don't have associated programs"
author: David
date: 2006/03/30

Recently, I was adding the ability to open files from an application at work. Luckily, I had run into this situation before, so I knew that you could run a Process.Start on the file in question and have Explorer open it for you. What I didn't know was that it would throw a Win32Exception if the file didn't have an associated program to open it. My next step was what any good developer would do: Google it.<br><br>Fairly early on in my searching, I came across a [post](http://www.nedbatchelder.com/blog/20050318T070512.html) by [Ned Batchelder](http://www.nedbatchelder.com/blog/index.html) that described the EXACT same scenario I was working on! Ned wanted to open a file with an unknown extension from a managed application just like me. He details his Google search and explains how he discovered information about the API functions, ShellExecute and ShellExecuteEx. Basically, you can call ShellExecuteEx with an "open" verb and Explorer will attempt to open the file. If it fails with an SE_ERR_NOASSOC error, then call ShellExecuteEx again but using an "openas" verb. Doesn't sound too bad, though some code snippets still would've sped the process up for me :-) I did learn it better this way, though.<br><br>Anyway, here's where I started. First, I pulled in the definition for the SHELLEXECUTEINFO structure.
<div style="FONT-SIZE: 9pt; FONT-FAMILY: Consolas, monospace; BACKGROUND-COLOR: white">
<span style="COLOR: navy">Friend</span><span style="COLOR: black"> </span><span style="COLOR: navy">Structure</span><span style="COLOR: black"> SHELLEXECUTEINFO<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> cbSize </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">Integer<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Public</span><span style="COLOR: black"> fMask </span><span style="COLOR: navy">As</span><span style="COLOR: black"> SEE_MASK<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> hwnd </span><span style="COLOR: navy">As</span><span style="COLOR: black"> IntPtr<br>    &lt;MarshalAs(UnmanagedType.LPTStr)&gt; _<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> lpVerb </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">String<br></span><span style="COLOR: black">    &lt;MarshalAs(UnmanagedType.LPTStr)&gt; _<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> lpFile </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">String<br></span><span style="COLOR: black">    &lt;MarshalAs(UnmanagedType.LPTStr)&gt; _<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> lpParameters </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">String<br></span><span style="COLOR: black">    &lt;MarshalAs(UnmanagedType.LPTStr)&gt; _<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> lpDirectory </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">String<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Dim</span><span style="COLOR: black"> nShow </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">Integer<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Dim</span><span style="COLOR: black"> hInstApp </span><span style="COLOR: navy">As</span><span style="COLOR: black"> SE_ERR<br></span><span style="COLOR: navy">Dim</span><span style="COLOR: black"> lpIDList </span><span style="COLOR: navy">As</span><span style="COLOR: black"> IntPtr<br>    &lt;MarshalAs(UnmanagedType.LPTStr)&gt; _<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> lpClass </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">String<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Public</span><span style="COLOR: black"> hkeyClass </span><span style="COLOR: navy">As</span><span style="COLOR: black"> IntPtr<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> dwHotKey </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">Integer<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Public</span><span style="COLOR: black"> hIcon </span><span style="COLOR: navy">As</span><span style="COLOR: black"> IntPtr<br></span><span style="COLOR: navy">Public</span><span style="COLOR: black"> hProcess </span><span style="COLOR: navy">As</span><span style="COLOR: black"> IntPtr<br></span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Structure</span> </div>

Next, I created definitions for the SW, SEE_MASK, and SE_ERR constants.
<div style="FONT-SIZE: 9pt; FONT-FAMILY: Consolas, monospace; BACKGROUND-COLOR: white">#<span style="COLOR: navy">Region</span><span style="COLOR: black"> </span><span style="COLOR: maroon">" SW Constants "<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Friend</span><span style="COLOR: black"> </span><span style="COLOR: navy">Enum</span><span style="COLOR: black"> SW </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">Integer<br></span><span style="COLOR: black">        HIDE = </span><span style="COLOR: red">0<br></span><span style="COLOR: black">        SHOWNORMAL = </span><span style="COLOR: red">1<br></span><span style="COLOR: black">        NORMAL = </span><span style="COLOR: red">1<br></span><span style="COLOR: black">        SHOWMINIMIZED = </span><span style="COLOR: red">2<br></span><span style="COLOR: black">        SHOWMAXIMIZED = </span><span style="COLOR: red">3<br></span><span style="COLOR: black">        MAXIMIZE = </span><span style="COLOR: red">3<br></span><span style="COLOR: black">        SHOWNOACTIVATE = </span><span style="COLOR: red">4<br></span><span style="COLOR: black">        SHOW = </span><span style="COLOR: red">5<br></span><span style="COLOR: black">        MINIMIZE = </span><span style="COLOR: red">6<br></span><span style="COLOR: black">        SHOWMINNOACTIVE = </span><span style="COLOR: red">7<br></span><span style="COLOR: black">        SHOWNA = </span><span style="COLOR: red">8<br></span><span style="COLOR: black">        RESTORE = </span><span style="COLOR: red">9<br></span><span style="COLOR: black">        SHOWDEFAULT = </span><span style="COLOR: red">10<br></span><span style="COLOR: black">        FORCEMINIMIZE = </span><span style="COLOR: red">11<br></span><span style="COLOR: black">        MAX = </span><span style="COLOR: red">11<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Enum<br></span><span style="COLOR: black">#</span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Region<br><br></span><span style="COLOR: black">#</span><span style="COLOR: navy">Region</span><span style="COLOR: black"> </span><span style="COLOR: maroon">" SEE_MASK Constants "<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Friend</span><span style="COLOR: black"> </span><span style="COLOR: navy">Enum</span><span style="COLOR: black"> SEE_MASK </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">Integer<br></span><span style="COLOR: black">        CLASSNAME = </span><span style="COLOR: red">&H1<br></span><span style="COLOR: black">        CLASSKEY = </span><span style="COLOR: red">&H3<br></span><span style="COLOR: black">        IDLIST = </span><span style="COLOR: red">&H4<br></span><span style="COLOR: black">        INVOKEIDLIST = </span><span style="COLOR: red">&HC<br></span><span style="COLOR: black">        ICON = </span><span style="COLOR: red">&H10<br></span><span style="COLOR: black">        HOTKEY = </span><span style="COLOR: red">&H20<br></span><span style="COLOR: black">        NOCLOSEPROCESS = </span><span style="COLOR: red">&H40<br></span><span style="COLOR: black">        CONNECTNETDRV = </span><span style="COLOR: red">&H80<br></span><span style="COLOR: black">        FLAG_DDEWAIT = </span><span style="COLOR: red">&H100<br></span><span style="COLOR: black">        DOENVSUBST = </span><span style="COLOR: red">&H200<br></span><span style="COLOR: black">        FLAG_NO_UI = </span><span style="COLOR: red">&H400<br></span><span style="COLOR: black">        UNICODE = </span><span style="COLOR: red">&H4000<br></span><span style="COLOR: black">        NO_CONSOLE = </span><span style="COLOR: red">&H8000<br></span><span style="COLOR: black">        ASYNCOK = </span><span style="COLOR: red">&H100000<br></span><span style="COLOR: black">        HMONITOR = </span><span style="COLOR: red">&H200000<br></span><span style="COLOR: black">        NOZONECHECKS = </span><span style="COLOR: red">&H800000<br></span><span style="COLOR: black">        NOQUERYCLASSSTORE = </span><span style="COLOR: red">&H1000000<br></span><span style="COLOR: black">        WAITFORINPUTIDLE = </span><span style="COLOR: red">&H2000000<br></span><span style="COLOR: black">        FLAG_LOG_USAGE = </span><span style="COLOR: red">&H4000000<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Enum<br></span><span style="COLOR: black">#</span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Region<br><br></span><span style="COLOR: black">#</span><span style="COLOR: navy">Region</span><span style="COLOR: black"> </span><span style="COLOR: maroon">" SE_ERR Constants "<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Friend</span><span style="COLOR: black"> </span><span style="COLOR: navy">Enum</span><span style="COLOR: black"> SE_ERR </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">Integer<br></span><span style="COLOR: black">        SE_ERR_FNF = </span><span style="COLOR: red">2</span><span style="COLOR: black">              </span><span style="COLOR: green">' file not found<br></span><span style="COLOR: black">        SE_ERR_PNF = </span><span style="COLOR: red">3</span><span style="COLOR: black">              </span><span style="COLOR: green">' path not found<br></span><span style="COLOR: black">        SE_ERR_ACCESSDENIED = </span><span style="COLOR: red">5</span><span style="COLOR: black">     </span><span style="COLOR: green">' access denied<br></span><span style="COLOR: black">        SE_ERR_OOM = </span><span style="COLOR: red">8</span><span style="COLOR: black">              </span><span style="COLOR: green">' out of memory<br></span><span style="COLOR: black">        SE_ERR_DLLNOTFOUND = </span><span style="COLOR: red">32<br></span><span style="COLOR: black">        SE_ERR_SHARE = </span><span style="COLOR: red">26<br></span><span style="COLOR: black">        SE_ERR_ASSOCINCOMPLETE = </span><span style="COLOR: red">27<br></span><span style="COLOR: black">        SE_ERR_DDETIMEOUT = </span><span style="COLOR: red">28<br></span><span style="COLOR: black">        SE_ERR_DDEFAIL = </span><span style="COLOR: red">29<br></span><span style="COLOR: black">        SE_ERR_DDEBUSY = </span><span style="COLOR: red">30<br></span><span style="COLOR: black">        SE_ERR_NOASSOC = </span><span style="COLOR: red">31<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Enum<br></span><span style="COLOR: black">#</span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Region</span> </div>

Finally, I created my definition for the ShellExecuteEx function.
<div style="FONT-SIZE: 9pt; FONT-FAMILY: Consolas, monospace; BACKGROUND-COLOR: white">&lt;DllImport(<span style="COLOR: maroon">"shell32.dll"</span><span style="COLOR: black">, CharSet:=CharSet.Auto, SetLastError:=</span><span style="COLOR: navy">True</span><span style="COLOR: black">)&gt; _<br></span><span style="COLOR: navy">Friend</span><span style="COLOR: black"> </span><span style="COLOR: navy">Shared</span><span style="COLOR: black"> </span><span style="COLOR: navy">Function</span><span style="COLOR: black"> ShellExecuteEx( _<br></span><span style="COLOR: navy">ByRef</span><span style="COLOR: black"> lpExecInfo </span><span style="COLOR: navy">As</span><span style="COLOR: black"> SHELLEXECUTEINFO) </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">Boolean<br></span><span style="COLOR: black"></span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Function</span> </div>

I stuck all of this into a NativeMethods class and tried the code below: 
<div style="FONT-SIZE: 9pt; FONT-FAMILY: Consolas, monospace; BACKGROUND-COLOR: white">
<span style="COLOR: navy">Dim</span><span style="COLOR: black"> info </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">New</span><span style="COLOR: black"> NativeMethods.SHELLEXECUTEINFO<br>info.cbSize = Marshal.SizeOf(info)<br>info.lpDirectory = Path.GetDirectoryName(fileToStart)<br>info.lpFile = Path.GetFileName(fileToStart)<br>info.nShow = NativeMethods.SW.SHOWDEFAULT<br>info.lpVerb = </span><span style="COLOR: maroon">"open"<br></span><span style="COLOR: black">info.fMask = NativeMethods.SEE_MASK.FLAG_NO_UI Or NativeMethods.SEE_MASK.FLAG_DDEWAIT<br><br></span><span style="COLOR: navy">If</span><span style="COLOR: black"> </span><span style="COLOR: navy">Not</span><span style="COLOR: black"> NativeMethods.ShellExecuteEx(info) </span><span style="COLOR: navy">Then<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">If</span><span style="COLOR: black"> info.hInstApp = NativeMethods.SE_ERR.SE_ERR_NOASSOC </span><span style="COLOR: navy">Then<br></span><span style="COLOR: black">        </span><span style="COLOR: navy">Dim</span><span style="COLOR: black"> sinfo </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">New</span><span style="COLOR: black"> NativeMethods.SHELLEXECUTEINFO<br>        sinfo.cbSize = Marshal.SizeOf(info)<br>        sinfo.lpVerb = </span><span style="COLOR: maroon">"openas"<br></span><span style="COLOR: black">        sinfo.lpDirectory = Path.GetDirectoryName(fileToStart)<br>        sinfo.lpFile = Path.GetFileName(fileToStart)<br>        sinfo.nShow = NativeMethods.SW.SHOWDEFAULT<br>        NativeMethods.ShellExecuteEx(sinfo)<br></span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">If<br></span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">If</span> </div>

<strong>UPDATED (9/12/2006):</strong> Many thanks to Michael and his comment regarding using the SEE_MASK.FLAG_DDEWAIT. That fixed all of the problems I was running into regarding the above code. (see the usage on info.fMask)

A quick note about the code: Ned mentioned in his post that he got the ERROR_NO_ASSOCATION error instead of SE_ERR_NOASSOC. Well, the ERROR_NO_ASSOCATION is what is returned in the Win32 error (Marshal.LastWin32Error). The SE_ERR_NOASSOC is returned in the hInstApp (see MSDN documentation [here](http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/structures/shellexecuteinfo.asp)). <br><br>See any problems with that? I certainly didn't (and still don't). It works like a charm for files with associations... however, it would only work one time for files without any associated program. Afterwards, it wouldn't give me anything... no errors, nada, zilch. After a few tries, an AccessViolationException would get thrown. Why? I have no idea. I tried various things to see if I should be cleaning up memory somewhere but I couldn't find anything. I did find out that if I just called ShellExecuteEx with the "openas" verb the first time, I wouldn't get any problems at all. What in the world???<br><br>As a result of the strange behavior, I changed my code slightly to look like this: 
<div style="FONT-SIZE: 9pt; FONT-FAMILY: Consolas, monospace; BACKGROUND-COLOR: white">
<span style="COLOR: navy">Try<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">Using</span><span style="COLOR: black"> p </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">New</span><span style="COLOR: black"> Process<br>        p.StartInfo.FileName = fileToStart<br>        p.StartInfo.UseShellExecute = </span><span style="COLOR: navy">True<br></span><span style="COLOR: black">        p.Start()<br></span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Using<br></span><span style="COLOR: navy">Catch</span><span style="COLOR: black"> win32Ex </span><span style="COLOR: navy">As</span><span style="COLOR: black"> Win32Exception<br></span><span style="COLOR: navy">Dim</span><span style="COLOR: black"> sinfo </span><span style="COLOR: navy">As</span><span style="COLOR: black"> </span><span style="COLOR: navy">New</span><span style="COLOR: black"> NativeMethods.SHELLEXECUTEINFO<br>    sinfo.cbSize = Marshal.SizeOf(sinfo)<br>    sinfo.lpVerb = </span><span style="COLOR: maroon">"openas"<br></span><span style="COLOR: black">    sinfo.lpDirectory = Path.GetDirectoryName(fileToStart)<br>    sinfo.lpFile = Path.GetFileName(fileToStart)<br>    sinfo.nShow = NativeMethods.SW.SHOWDEFAULT<br><br></span><span style="COLOR: navy">If</span><span style="COLOR: black"> </span><span style="COLOR: navy">Not</span><span style="COLOR: black"> NativeMethods.ShellExecuteEx(sinfo) </span><span style="COLOR: navy">Then<br></span><span style="COLOR: black">        </span><span style="COLOR: navy">Throw</span><span style="COLOR: black"> </span><span style="COLOR: navy">New</span><span style="COLOR: black"> Win32Exception<br></span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">If<br></span><span style="COLOR: navy">End</span><span style="COLOR: black"> </span><span style="COLOR: navy">Try</span> </div>

The above code is working like a charm. I still have no idea why my first example won't work for me. If anyone has any ideas or suggestions, please let me know. I haven't worked with Interop between managed and unmanaged code very much. My experience up to this point has primarily been an entirely managed project or an entirely unmanaged project (and that only in college).

<strong>NOTES:</strong> Here are some resources I found while researching this:

[[http://www.nedbatchelder.com/blog/20050318T070512.html](http://www.nedbatchelder.com/blog/20050318T070512.html)]<br>[[http://www.pinvoke.net/default.aspx/shell32/ShellExecuteEx.html](http://www.pinvoke.net/default.aspx/shell32/ShellExecuteEx.html)]<br>[[http://www.pinvoke.net/default.aspx/Constants/SW.html](http://www.pinvoke.net/default.aspx/Constants/SW.html)]<br>[[http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/structures/shellexecuteinfo.asp](http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/reference/structures/shellexecuteinfo.asp)]

Also, be sure to look at the ShellAPI.h header file!<br>
