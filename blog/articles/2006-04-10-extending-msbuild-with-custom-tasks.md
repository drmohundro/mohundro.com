
title: "Extending MSBuild with custom tasks"
author: David
date: 2006/04/10

MSBuild is a great tool. If you're not familiar with it, it is Microsoft's new build engine which was released with .NET 2.0. Visual Studio 2005 uses it behind the scenes. If you'd like to see it in action, pull up a VS2005 Command Prompt and type "msbuild YourSolution.sln" and watch the magic. It provides a much faster way of recompiling solutions and projects than reopening Visual Studio.

MSBuild runs off XML files. If you'd like to see one, just open up one of your vbproj or csproj files. Visual Studio projects default to the MSBuild format. Unfortunately, the solution files still aren't in an XML format. Because it uses XML, you can extend a build to do any number of tasks. I'll walk you through a very simple example.

My task is a Replace task that simple takes an input string (likely a file path or assembly name), an old value, and a new value and returns a value with all old values replaced with new values. It works exactly like the Replace method off of String objects.

First off, create a new Class Library project in Visual Studio. You'll need to add a reference to Microsoft.Build.Framework and to Microsoft.Build.Utilities. Next, for your class, inherit from Microsoft.Build.Utilities.Task. You'll be forced to override an Execute method. That's really all it takes to get a custom task. Everything else is driven off of public properties that are described by specific MSBuild attributes like "Required" or "Output".

Here's the source for my Replace task:
<div style="FONT-SIZE: 9pt; FONT-FAMILY: Consolas, monospace; BACKGROUND-COLOR: white">
<span style="COLOR: navy">using</span><span style="COLOR: black"> Microsoft.Build.Framework;<br></span><span style="COLOR: navy">using</span><span style="COLOR: black"> Microsoft.Build.Utilities;<br><br></span><span style="COLOR: navy">using</span><span style="COLOR: black"> System;<br></span><span style="COLOR: navy">using</span><span style="COLOR: black"> System.Collections.Generic;<br></span><span style="COLOR: navy">using</span><span style="COLOR: black"> System.Text;<br><br></span><span style="COLOR: navy">namespace</span><span style="COLOR: black"> Tasks<br>{<br></span><span style="COLOR: gray">///</span><span style="COLOR: black"> </span><span style="COLOR: gray">&lt;summary&gt;<br></span><span style="COLOR: black">    </span><span style="COLOR: gray">///</span><span style="COLOR: black"> Custom MSBuild task to perform String replacement. Primarily used for<br></span><span style="COLOR: gray">///</span><span style="COLOR: black"> Namespace to directory replacement (DTC.NRA.App -&gt; DTC\NRA\App).<br></span><span style="COLOR: gray">///</span><span style="COLOR: black"> </span><span style="COLOR: gray">&lt;/summary&gt;<br></span><span style="COLOR: black">    </span><span style="COLOR: navy">public</span><span style="COLOR: black"> </span><span style="COLOR: navy">class</span><span style="COLOR: black"> </span><span style="COLOR: teal">Replace</span><span style="COLOR: black"> : </span><span style="COLOR: teal">Task<br></span><span style="COLOR: black">    {<br></span><span style="COLOR: navy">string</span><span style="COLOR: black"> _input;<br>        [</span><span style="COLOR: teal">Required</span><span style="COLOR: black">]<br></span><span style="COLOR: navy">public</span><span style="COLOR: black"> </span><span style="COLOR: navy">string</span><span style="COLOR: black"> Input<br>        {<br></span><span style="COLOR: navy">get</span><span style="COLOR: black"> { </span><span style="COLOR: navy">return</span><span style="COLOR: black"> _input; }<br></span><span style="COLOR: navy">set</span><span style="COLOR: black"> { _input = </span><span style="COLOR: navy">value</span><span style="COLOR: black">; }<br>        }<br><br></span><span style="COLOR: navy">string</span><span style="COLOR: black"> _oldValue;<br>        [</span><span style="COLOR: teal">Required</span><span style="COLOR: black">]<br></span><span style="COLOR: navy">public</span><span style="COLOR: black"> </span><span style="COLOR: navy">string</span><span style="COLOR: black"> OldValue<br>        {<br></span><span style="COLOR: navy">get</span><span style="COLOR: black"> { </span><span style="COLOR: navy">return</span><span style="COLOR: black"> _oldValue; }<br></span><span style="COLOR: navy">set</span><span style="COLOR: black"> { _oldValue = </span><span style="COLOR: navy">value</span><span style="COLOR: black">; }<br>        }<br><br></span><span style="COLOR: navy">string</span><span style="COLOR: black"> _newValue;<br>        [</span><span style="COLOR: teal">Required</span><span style="COLOR: black">]<br></span><span style="COLOR: navy">public</span><span style="COLOR: black"> </span><span style="COLOR: navy">string</span><span style="COLOR: black"> NewValue<br>        {<br></span><span style="COLOR: navy">get</span><span style="COLOR: black"> { </span><span style="COLOR: navy">return</span><span style="COLOR: black"> _newValue; }<br></span><span style="COLOR: navy">set</span><span style="COLOR: black"> { _newValue = </span><span style="COLOR: navy">value</span><span style="COLOR: black">; }<br>        }<br><br></span><span style="COLOR: navy">string</span><span style="COLOR: black"> _results;<br>        [</span><span style="COLOR: teal">Output</span><span style="COLOR: black">]<br></span><span style="COLOR: navy">public</span><span style="COLOR: black"> </span><span style="COLOR: navy">string</span><span style="COLOR: black"> Results<br>        {<br></span><span style="COLOR: navy">get</span><span style="COLOR: black"> { </span><span style="COLOR: navy">return</span><span style="COLOR: black"> _results; }<br></span><span style="COLOR: navy">set</span><span style="COLOR: black"> { _results = </span><span style="COLOR: navy">value</span><span style="COLOR: black">; }<br>        }<br><br></span><span style="COLOR: navy">public</span><span style="COLOR: black"> </span><span style="COLOR: navy">override</span><span style="COLOR: black"> </span><span style="COLOR: navy">bool</span><span style="COLOR: black"> Execute()<br>        {<br></span><span style="COLOR: navy">bool</span><span style="COLOR: black"> success = </span><span style="COLOR: navy">true</span><span style="COLOR: black">;<br></span><span style="COLOR: navy">try<br></span><span style="COLOR: black">            {<br>                Results = Input.Replace(OldValue, NewValue);<br>            }<br></span><span style="COLOR: navy">catch</span><span style="COLOR: black"> (</span><span style="COLOR: teal">Exception</span><span style="COLOR: black"> e)<br>            {<br>                Log.LogErrorFromException(e);<br>            }<br></span><span style="COLOR: navy">return</span><span style="COLOR: black"> success;<br>        }<br>    }<br>}<br></span>
</div>

The XML below is how I'm currently using this task.
<div style="FONT-SIZE: 9pt; FONT-FAMILY: Consolas, monospace; BACKGROUND-COLOR: white">
<span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">UsingTask</span><span style="COLOR: blue"> </span><span style="COLOR: red">TaskName</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">Tasks.Replace</span><span style="COLOR: black">"</span><span style="COLOR: blue"> </span><span style="COLOR: red">AssemblyFile</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">C:\Development\References\MSBuildTasks.dll</span><span style="COLOR: black">"</span><span style="COLOR: blue"> /&gt;<br>&lt;</span><span style="COLOR: maroon">PropertyGroup</span><span style="COLOR: blue">&gt;<br>  &lt;</span><span style="COLOR: maroon">RootDirectory</span><span style="COLOR: blue">&gt;</span><span style="COLOR: black">C:\Development\Build\</span><span style="COLOR: blue">&lt;/</span><span style="COLOR: maroon">RootDirectory</span><span style="COLOR: blue">&gt;<br>&lt;/</span><span style="COLOR: maroon">PropertyGroup</span><span style="COLOR: blue">&gt;<br>&lt;</span><span style="COLOR: maroon">Target</span><span style="COLOR: blue"> </span><span style="COLOR: red">Name</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">AfterBuild</span><span style="COLOR: black">"</span><span style="COLOR: blue">&gt;<br>  &lt;</span><span style="COLOR: maroon">Replace</span><span style="COLOR: blue"> </span><span style="COLOR: red">Input</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">$(RootNamespace)</span><span style="COLOR: black">"</span><span style="COLOR: blue"> </span><span style="COLOR: red">OldValue</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">.</span><span style="COLOR: black">"</span><span style="COLOR: blue"> </span><span style="COLOR: red">NewValue</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">\</span><span style="COLOR: black">"</span><span style="COLOR: blue">&gt;<br>    &lt;</span><span style="COLOR: maroon">Output</span><span style="COLOR: blue"> </span><span style="COLOR: red">TaskParameter</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">Results</span><span style="COLOR: black">"</span><span style="COLOR: blue"> </span><span style="COLOR: red">PropertyName</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">NamespaceDirectories</span><span style="COLOR: black">"</span><span style="COLOR: blue"> /&gt;<br>  &lt;/</span><span style="COLOR: maroon">Replace</span><span style="COLOR: blue">&gt;<br>  &lt;</span><span style="COLOR: maroon">CreateItem</span><span style="COLOR: blue"> </span><span style="COLOR: red">Include</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">$(OutputPath)\**\*.*</span><span style="COLOR: black">"</span><span style="COLOR: blue">&gt;<br>    &lt;</span><span style="COLOR: maroon">Output</span><span style="COLOR: blue"> </span><span style="COLOR: red">TaskParameter</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">Include</span><span style="COLOR: black">"</span><span style="COLOR: blue"> </span><span style="COLOR: red">ItemName</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">FilesToArchive</span><span style="COLOR: black">"</span><span style="COLOR: blue"> /&gt;<br>  &lt;/</span><span style="COLOR: maroon">CreateItem</span><span style="COLOR: blue">&gt;<br>  &lt;</span><span style="COLOR: maroon">Copy</span><span style="COLOR: blue"> </span><span style="COLOR: red">SourceFiles</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">@(FilesToArchive)</span><span style="COLOR: black">"</span><span style="COLOR: blue"> </span><span style="COLOR: red">DestinationFolder</span><span style="COLOR: blue">=</span><span style="COLOR: black">"</span><span style="COLOR: blue">$(RootDirectory)$(NamespaceDirectories)\%(FilesToArchive.RecursiveDir)</span><span style="COLOR: black">"</span><span style="COLOR: blue"> /&gt;<br>&lt;/</span><span style="COLOR: maroon">Target</span><span style="COLOR: blue">&gt;</span> </div>

As you can see, I've got the UsingTask which references the assembly I built. Then you can use the Replace task like any other provided task. The above exactly can be copied into a Visual Studio project and it will copy the output files from your build into the RootDirectory you specify with the root namespace making up the folders beneath it (i.e. give the namespace System.Windows.Forms, this will copy your compiled assemblies to c:\Development\Build\System\Windows\Forms\*).
